<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Dubai | SMOU</title>

  <!-- Chart.js (اختياري) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#1c6670;
      --brand2:#15545c;
      --bg:#f3f5f6;
      --card:#fff;
      --muted:#6b7c85;
      --grid:#e7ecef;
      --danger:#c62828;
      --ok:#2e7d32;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma,Arial,sans-serif;background:var(--bg);color:#0b2230;padding:18px}
    .wrap{max-width:1400px;margin:0 auto}
    .card{background:var(--card);border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.10);padding:16px;border:1px solid rgba(0,0,0,.05)}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:12px;border:1px solid rgba(0,0,0,.08);object-fit:contain;background:#fff;padding:6px}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button,.chip{font-family:inherit;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px 12px;font-weight:700}
    button{background:var(--brand);color:#fff;border:1px solid rgba(255,255,255,.15);cursor:pointer;box-shadow:0 10px 22px rgba(28,102,112,.15)}
    button:hover{background:var(--brand2)}
    .chip{background:#fff;color:#0b2230;cursor:default;font-weight:800}
    .chip b{color:var(--brand)}
    .danger{background:#fff;color:var(--danger);border-color:rgba(198,40,40,.35);cursor:pointer}
    .danger:hover{background:#fff1f1}
    .mutedBtn{background:#0f2f35}
    .mutedBtn:hover{background:#0b2429}
    .fileInput{display:none}

    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media (max-width:1100px){.grid2{grid-template-columns:1fr}}

    .tableWrap{overflow:auto;border-radius:14px;border:1px solid rgba(0,0,0,.08)}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1100px;background:#fff}
    thead th{position:sticky;top:0;z-index:2;background:#e9f1f2;border-bottom:1px solid rgba(0,0,0,.10);padding:10px;font-size:13px;white-space:nowrap;text-align:center}
    tbody td{border-bottom:1px solid var(--grid);padding:8px;text-align:center;vertical-align:middle;font-size:13px;background:#fff}
    tbody tr:hover td{background:#fbfdff}
    th.stickyRight, td.stickyRight{position:sticky;right:0;z-index:3;background:#fff;box-shadow:-10px 0 14px rgba(0,0,0,.04);text-align:right;min-width:260px}
    thead th.stickyRight{background:#e9f1f2}
    th.small, td.small{min-width:84px}
    th.wide, td.wide{min-width:120px}
    .kpiName{font-weight:800;line-height:1.25}
    .hint{color:var(--muted);font-size:12px;margin-top:3px}

    input[type="number"]{width:88px;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.14);font-weight:800;text-align:center;outline:none}
    input[type="number"]:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(28,102,112,.12)}
    .scoreCell{font-weight:900;border-right:1px solid var(--grid);min-width:78px;margin-top:6px}
    .scoreOk{color:var(--ok)}
    .scoreBad{color:var(--danger)}

    .totalRow td{background:#0f2f35 !important;color:#fff;font-weight:900;border-bottom:none}
    .totalRow td.stickyRight{background:#0f2f35 !important}
    .totalBadge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);min-width:64px}

    .chartCard{padding:14px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:#fff}
    .chartHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .chartHead h2{margin:0;font-size:16px}
    .legendNote{color:var(--muted);font-size:12px}
    canvas{max-height:420px}
    .foot{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <header>
      <div class="title">
        <img class="logo" src="logo.png" alt="SMOU Logo" onerror="this.style.display='none'">
        <div>
          <h1>نظام KPI للمناديب — دبي</h1>
          <div class="sub">
            أدخل القيم لكل مندوب، وسيتم احتساب النتيجة النهائية <b>من 100</b> (حتى لو مجموع الأوزان 80 أو غيره) + مخطط الأداء (إذا توفّر Chart.js).
          </div>
        </div>
      </div>

      <div class="toolbar">
        <span class="chip">متوسط الإجمالي: <b id="grandTotal">0</b> / 100</span>
        <span class="chip">مجموع الأوزان: <b id="sumWeightsTop">—</b></span>
        <button class="mutedBtn" id="addRepBtn">إضافة مندوب</button>
        <button id="exportBtn">تصدير (JSON)</button>
        <button id="importBtn">استيراد (JSON)</button>
        <input class="fileInput" id="importFile" type="file" accept="application/json" />
        <button class="danger" id="resetBtn">مسح القيم</button>
      </div>
    </header>

    <div class="grid2">

      <div>
        <div class="tableWrap">
          <table id="kpiTable">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="foot">
          <b>طريقة الحساب:</b><br>
          النقاط لكل بند = <code>min(Actual ÷ Target, 1) × Weight</code><br>
          ثم يتم تحويل المجموع إلى 100: <code>(Total ÷ SumWeights) × 100</code><br>
          ✅ بهذه الطريقة لو مجموع الأوزان = 80، أعلى نتيجة ممكنة تصبح 100 بدل 80.
        </div>
      </div>

      <div class="chartCard">
        <div class="chartHead">
          <h2>مخطط الأداء</h2>
          <div class="legendNote" id="chartStatus">النتيجة من 100</div>
        </div>
        <canvas id="chart"></canvas>
        <div class="foot" id="chartHint"></div>
      </div>

    </div>

  </div>
</div>

<script>
/* =========================
   KPI Web App (Single-file)
   - LocalStorage
   - Export/Import JSON
   - Chart.js optional
   - Totals normalized to 100
   ========================= */

const STORAGE_KEY = "smou_kpi_dubai_reps_v1";

/* البنود (تقدر تعدلها) */
const defaultKpis = [
  { id:"k1", name:"عدد الزيارات الشهرية لمواقع المشاريع", target:80,  weight:10 },
  { id:"k2", name:"عدد الزيارات الشهرية للمكاتب",         target:100, weight:10 },
  { id:"k3", name:"عدد عروض الأسعار",                   target:25,  weight:10 },
  { id:"k4", name:"الالتزام بمواعيد الحضور والانصراف",     target:25,  weight:10 },
  { id:"k5", name:"المظهر العام",                            target:10,  weight:10 },
  { id:"k6", name:"الالتزام بإرسال التقارير",              target:25,  weight:10 },
  { id:"k7", name:"متابعة نسب العمل الأسبوعي (مسح حديث)",  target:4,   weight:10 },
  { id:"k8", name:"إرسال كشف السوشيال ميديا",              target:4,   weight:10 },
];

/* أسماء المناديب (عدّلها) */
const defaultReps = [
  "أحمد عبدالله","ماهر عامر","رؤوف المشير","عمر شلش",
  "محمد السعودي","أحمد المغازي","أمير نبيل"
];

let state = loadState();
let chart = null;

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { kpis: defaultKpis, reps: defaultReps, actuals:{} };
    const parsed = JSON.parse(raw);
    if(!parsed.kpis || !parsed.reps) throw new Error("Bad");
    if(!parsed.actuals) parsed.actuals = {};
    return parsed;
  }catch(e){
    return { kpis: defaultKpis, reps: defaultReps, actuals:{} };
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function ensureActuals(){
  for(const k of state.kpis){
    if(!state.actuals[k.id]) state.actuals[k.id] = Array(state.reps.length).fill(0);
    if(state.actuals[k.id].length !== state.reps.length){
      const old = state.actuals[k.id];
      state.actuals[k.id] = Array(state.reps.length).fill(0).map((_,i)=> old[i] ?? 0);
    }
  }
}

function round1(n){ return Math.round((n + Number.EPSILON) * 10) / 10; }

function sumWeights(){
  return state.kpis.reduce((s,k)=> s + (Number(k.weight) || 0), 0);
}

function scoreFor(kpi, actual){
  const a = Number(actual) || 0;
  const t = Number(kpi.target) || 0;
  const w = Number(kpi.weight) || 0;
  if(t <= 0) return 0;
  return Math.min(a / t, 1) * w; // يعطي نقاط من وزن البند
}

/* ✅ الإجمالي النهائي من 100 حتى لو مجموع الأوزان 80 */
function totalForRep(idx){
  let total = 0;
  const maxW = sumWeights();
  for(const k of state.kpis){
    const actual = (state.actuals[k.id] && state.actuals[k.id][idx]) ?? 0;
    total += scoreFor(k, actual);
  }
  if(maxW <= 0) return 0;
  const normalized = (total / maxW) * 100;
  return round1(normalized);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function render(){
  ensureActuals();

  document.getElementById("sumWeightsTop").textContent = sumWeights();

  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  const tr1 = document.createElement("tr");

  const thKpi = document.createElement("th");
  thKpi.className = "stickyRight wide";
  thKpi.textContent = "بنود التقييم";
  tr1.appendChild(thKpi);

  const thTarget = document.createElement("th");
  thTarget.className = "small";
  thTarget.textContent = "المطلوب";
  tr1.appendChild(thTarget);

  const thWeight = document.createElement("th");
  thWeight.className = "small";
  thWeight.textContent = "الوزن";
  tr1.appendChild(thWeight);

  state.reps.forEach((name) => {
    const th = document.createElement("th");
    th.className = "wide";
    th.innerHTML = `${escapeHtml(name)}<div class="hint">Actual / Score</div>`;
    tr1.appendChild(th);
  });

  thead.appendChild(tr1);

  state.kpis.forEach((kpi) => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.className = "stickyRight";
    tdName.innerHTML = `<div class="kpiName">${escapeHtml(kpi.name)}</div>`;
    tr.appendChild(tdName);

    const tdTarget = document.createElement("td");
    tdTarget.className = "small";
    tdTarget.textContent = kpi.target;
    tr.appendChild(tdTarget);

    const tdWeight = document.createElement("td");
    tdWeight.className = "small";
    tdWeight.textContent = kpi.weight;
    tr.appendChild(tdWeight);

    state.reps.forEach((_, repIdx) => {
      const td = document.createElement("td");

      const val = state.actuals[kpi.id][repIdx] ?? 0;

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = val;

      const scoreSpan = document.createElement("div");
      scoreSpan.className = "scoreCell";
      const s = scoreFor(kpi, val);
      scoreSpan.textContent = round1(s);

      const ratio = kpi.target > 0 ? Math.min((Number(val)||0)/kpi.target, 1) : 0;
      scoreSpan.classList.toggle("scoreOk", ratio >= 0.8);
      scoreSpan.classList.toggle("scoreBad", ratio < 0.5);

      input.addEventListener("input", () => {
        const n = Number(input.value) || 0;
        state.actuals[kpi.id][repIdx] = n;

        const newScore = scoreFor(kpi, n);
        scoreSpan.textContent = round1(newScore);

        const newRatio = kpi.target > 0 ? Math.min(n/kpi.target, 1) : 0;
        scoreSpan.classList.toggle("scoreOk", newRatio >= 0.8);
        scoreSpan.classList.toggle("scoreBad", newRatio < 0.5);

        saveState();
        renderTotalsAndChart();
      });

      td.appendChild(input);
      td.appendChild(scoreSpan);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // Totals row
  const trTot = document.createElement("tr");
  trTot.className = "totalRow";

  const tdTotName = document.createElement("td");
  tdTotName.className = "stickyRight";
  tdTotName.textContent = "الإجمالي (من 100)";
  trTot.appendChild(tdTotName);

  const tdEmpty1 = document.createElement("td");
  tdEmpty1.textContent = "";
  trTot.appendChild(tdEmpty1);

  const tdSumW = document.createElement("td");
  tdSumW.id = "sumWeightsCell";
  tdSumW.textContent = sumWeights();
  trTot.appendChild(tdSumW);

  state.reps.forEach((_, repIdx) => {
    const td = document.createElement("td");
    td.innerHTML = `<span class="totalBadge" id="tot_${repIdx}">0</span>`;
    trTot.appendChild(td);
  });

  tbody.appendChild(trTot);

  renderTotalsAndChart();
}

function renderTotalsAndChart(){
  const totals = state.reps.map((_, i) => totalForRep(i));
  totals.forEach((t, i) => {
    const el = document.getElementById(`tot_${i}`);
    if(el) el.textContent = t;
  });

  const avg = totals.length ? round1(totals.reduce((a,b)=>a+b,0)/totals.length) : 0;
  document.getElementById("grandTotal").textContent = avg;

  // تحديث مجموع الأوزان في الصف الأخير
  const sumWEl = document.getElementById("sumWeightsCell");
  if(sumWEl) sumWEl.textContent = sumWeights();

  // Chart (اختياري) — لا يوقف الصفحة لو غير متاح
  try{
    if(typeof Chart === "undefined"){
      document.getElementById("chartStatus").textContent = "المخطط غير متاح (Chart.js غير محمّل)";
      document.getElementById("chartHint").textContent = "الإجمالي شغال، لكن المخطط يحتاج تحميل Chart.js أو اتصال يسمح بالـ CDN.";
      return;
    }else{
      document.getElementById("chartStatus").textContent = "النتيجة من 100";
      document.getElementById("chartHint").textContent = "";
    }

    if(!chart){
      const ctx = document.getElementById("chart");
      chart = new Chart(ctx, {
        type: "bar",
        data: { labels: state.reps, datasets: [{ label:"النتيجة", data: totals }] },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, max:100 } },
          plugins:{ legend:{display:false} }
        }
      });
    }else{
      chart.data.labels = state.reps;
      chart.data.datasets[0].data = totals;
      chart.update();
    }
  }catch(e){
    document.getElementById("chartStatus").textContent = "حدث خطأ في المخطط";
    document.getElementById("chartHint").textContent = "الإجمالي شغال، لكن المخطط يحتاج Chart.js.";
  }
}

// Actions
document.getElementById("addRepBtn").addEventListener("click", () => {
  const name = prompt("اكتب اسم المندوب الجديد:");
  if(!name) return;
  state.reps.push(name.trim());
  for(const k of state.kpis){
    if(!state.actuals[k.id]) state.actuals[k.id] = [];
    state.actuals[k.id].push(0);
  }
  saveState();
  render();
});

document.getElementById("resetBtn").addEventListener("click", () => {
  if(!confirm("هل تريد مسح جميع القيم؟")) return;
  state = { kpis: defaultKpis, reps: defaultReps, actuals:{} };
  saveState();
  render();
});

document.getElementById("exportBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "smou-kpi-dubai-reps.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const imported = JSON.parse(txt);
    if(!imported.kpis || !imported.reps) throw new Error("ملف غير صالح");
    if(!imported.actuals) imported.actuals = {};
    state = imported;
    saveState();
    render();
  }catch(err){
    alert("فشل الاستيراد: " + err.message);
  }finally{
    e.target.value = "";
  }
});

// Start
render();
</script>
</body>
</html>
