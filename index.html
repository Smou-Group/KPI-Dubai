<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Dubai | SMOU</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#1c6670;
      --brand2:#15545c;
      --bg:#f3f5f6;
      --card:#fff;
      --muted:#6b7c85;
      --grid:#e7ecef;
      --danger:#c62828;
      --ok:#2e7d32;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Tahoma, Arial, sans-serif;
      background:var(--bg);
      color:#0b2230;
      padding:18px;
    }
    .wrap{max-width:1400px;margin:0 auto}
    .card{
      background:var(--card);
      border-radius:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.10);
      padding:16px;
      border:1px solid rgba(0,0,0,.05);
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      object-fit:contain;background:#fff;padding:6px;
    }
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    button,.chip, input[type="text"]{
      font-family: inherit;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
    }
    button{
      background:var(--brand);
      color:#fff;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 10px 22px rgba(28,102,112,.15);
    }
    button:hover{background:var(--brand2)}
    .chip{
      background:#fff;
      color:#0b2230;
      cursor:default;
      font-weight:800;
    }
    .chip b{color:var(--brand)}
    .danger{background:#fff;color:var(--danger);border-color: rgba(198,40,40,.35); cursor:pointer}
    .danger:hover{background:#fff1f1}
    .mutedBtn{background:#0f2f35}
    .mutedBtn:hover{background:#0b2429}
    .fileInput{display:none}

    .grid2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 1100px){
      .grid2{grid-template-columns:1fr}
    }

    /* Table */
    .tableWrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      min-width:1100px;
      background:#fff;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: #e9f1f2;
      border-bottom:1px solid rgba(0,0,0,.10);
      padding:10px;
      font-size:13px;
      white-space:nowrap;
      text-align:center;
    }
    tbody td{
      border-bottom:1px solid var(--grid);
      padding:8px;
      text-align:center;
      vertical-align:middle;
      font-size:13px;
      background:#fff;
    }
    tbody tr:hover td{background:#fbfdff}
    th.stickyRight, td.stickyRight{
      position:sticky;
      right:0;
      z-index:3;
      background:#fff;
      box-shadow: -10px 0 14px rgba(0,0,0,.04);
      text-align:right;
      min-width:260px;
    }
    thead th.stickyRight{background:#e9f1f2}
    th.small, td.small{min-width:84px}
    th.wide, td.wide{min-width:120px}
    .kpiName{
      font-weight:800;
      line-height:1.25;
    }
    .hint{color:var(--muted);font-size:12px;margin-top:3px}

    input[type="number"]{
      width:88px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.14);
      font-weight:800;
      text-align:center;
      outline:none;
    }
    input[type="number"]:focus{
      border-color: var(--brand);
      box-shadow:0 0 0 3px rgba(28,102,112,.12);
    }
    .scoreCell{
      font-weight:900;
      border-right:1px solid var(--grid);
      min-width:78px;
    }
    .scoreOk{color:var(--ok)}
    .scoreBad{color:var(--danger)}
    .totalRow td{
      background:#0f2f35 !important;
      color:#fff;
      font-weight:900;
      border-bottom:none;
    }
    .totalRow td.stickyRight{background:#0f2f35 !important}
    .totalBadge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      min-width:64px;
    }

    /* Chart card */
    .chartCard{
      padding:14px;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      background:#fff;
    }
    .chartHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .chartHead h2{margin:0;font-size:16px}
    .legendNote{color:var(--muted);font-size:12px}
    canvas{max-height:420px}
    .foot{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <header>
      <div class="title">
        <img class="logo" src="logo.png" alt="SMOU Logo" onerror="this.style.display='none'">
        <div>
          <h1>نظام KPI للمشرفين — دبي</h1>
          <div class="sub">أدخل القيم لكل مشرف، وسيتم احتساب النتيجة من 100 وإنشاء مخطط الأداء تلقائيًا.</div>
        </div>
      </div>

      <div class="toolbar">
        <span class="chip">الإجمالي: <b id="grandTotal">—</b></span>
        <button class="mutedBtn" id="addSupervisorBtn">إضافة مشرف</button>
        <button id="exportBtn">تصدير البيانات (JSON)</button>
        <button id="importBtn">استيراد (JSON)</button>
        <input class="fileInput" id="importFile" type="file" accept="application/json" />
        <button class="danger" id="resetBtn">مسح الكل</button>
      </div>
    </header>

    <div class="grid2">

      <!-- TABLE -->
      <div>
        <div class="tableWrap">
          <table id="kpiTable">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="foot">
          ✅ طريقة الحساب: لكل بند وزن (Weight) + قيمة مطلوبة (Target).<br>
          النقاط = min(Actual ÷ Target, 1) × Weight. والنتيجة النهائية = مجموع نقاط البنود (حتى 100).<br>
          يمكنك تعديل البنود/الأوزان/التارجت من داخل الكود بسهولة أو أخبرني أعدله لك حسب نظامكم.
        </div>
      </div>

      <!-- CHART -->
      <div class="chartCard">
        <div class="chartHead">
          <h2>مخطط الأداء</h2>
          <div class="legendNote">النتيجة من 100</div>
        </div>
        <canvas id="chart"></canvas>
      </div>

    </div>
  </div>
</div>

<script>
/**
 * KPI Web App (Single-file)
 * - Saves to localStorage automatically
 * - Export/Import JSON
 * - Chart (Chart.js)
 * - RTL friendly
 */

const STORAGE_KEY = "smou_kpi_dubai_v1";

// 1) Define KPI items (based on your image)
const defaultKpis = [
  { id:"k1", name:"عدد الزيارات الشهرية لمواقع المشاريع", target:80,  weight:10 },
  { id:"k2", name:"عدد الزيارات الشهرية للمكاتب",         target:100, weight:10 },
  { id:"k3", name:"متابعة عروض الأسعار",                   target:25,  weight:10 },
  { id:"k4", name:"الالتزام بمواعيد الحضور والانصراف",     target:25,  weight:10 },
  { id:"k5", name:"جودة العمل",                            target:10,  weight:10 },
  { id:"k6", name:"الالتزام بإرسال التقارير",              target:25,  weight:10 },
  { id:"k7", name:"متابعة نسب العمل الأسبوعي (مسح حديث)",  target:4,   weight:10 },
  { id:"k8", name:"إرسال كشف السوشيال ميديا",              target:4,   weight:10 },
];

// 2) Default supervisors (edit as you like)
const defaultSupervisors = [
  "أحمد عبدالله",
  "ماهر عامر",
  "رؤوف المنشر",
  "عمر سلمان",
  "محمد السعدوني",
  "أحمد العقاري",
  "أمير نبيل"
];

// App state
let state = loadState();

// Chart
let chart;

// ---------- State helpers ----------
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      return {
        kpis: defaultKpis,
        supervisors: defaultSupervisors,
        // actuals[kpiId][supervisorIndex] = number
        actuals: {}
      };
    }
    const parsed = JSON.parse(raw);
    // minimal validation
    if(!parsed.kpis || !parsed.supervisors) throw new Error("Bad state");
    return parsed;
  }catch(e){
    return { kpis: defaultKpis, supervisors: defaultSupervisors, actuals:{} };
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function ensureActuals(){
  for(const k of state.kpis){
    if(!state.actuals[k.id]) state.actuals[k.id] = Array(state.supervisors.length).fill(0);
    // if supervisors changed
    if(state.actuals[k.id].length !== state.supervisors.length){
      const arr = state.actuals[k.id];
      state.actuals[k.id] = Array(state.supervisors.length).fill(0).map((_,i)=> arr[i] ?? 0);
    }
  }
}

// ---------- Scoring ----------
function scoreFor(kpi, actual){
  const a = Number(actual) || 0;
  const t = Number(kpi.target) || 0;
  const w = Number(kpi.weight) || 0;
  if(t <= 0) return 0;
  const ratio = Math.min(a / t, 1);
  return ratio * w;
}

function totalForSupervisor(idx){
  let total = 0;
  for(const k of state.kpis){
    const actual = (state.actuals[k.id] && state.actuals[k.id][idx]) ?? 0;
    total += scoreFor(k, actual);
  }
  return round1(total);
}

function round1(n){
  return Math.round((n + Number.EPSILON) * 10) / 10;
}

// ---------- Render Table ----------
function render(){
  ensureActuals();

  // Build THEAD
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  const tr1 = document.createElement("tr");

  // Right sticky KPI column
  const thKpi = document.createElement("th");
  thKpi.className = "stickyRight wide";
  thKpi.textContent = "بنود التقييم";
  tr1.appendChild(thKpi);

  // Target & Weight columns
  const thTarget = document.createElement("th");
  thTarget.className = "small";
  thTarget.textContent = "المطلوب";
  tr1.appendChild(thTarget);

  const thWeight = document.createElement("th");
  thWeight.className = "small";
  thWeight.textContent = "الوزن";
  tr1.appendChild(thWeight);

  // Supervisor columns (each has: actual + score)
  state.supervisors.forEach((name, i) => {
    const th = document.createElement("th");
    th.className = "wide";
    th.innerHTML = `${escapeHtml(name)}<div class="hint">Actual / Score</div>`;
    tr1.appendChild(th);
  });

  thead.appendChild(tr1);

  // Build KPI rows
  state.kpis.forEach((kpi, rowIdx) => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.className = "stickyRight";
    tdName.innerHTML = `<div class="kpiName">${escapeHtml(kpi.name)}</div>`;
    tr.appendChild(tdName);

    const tdTarget = document.createElement("td");
    tdTarget.className = "small";
    tdTarget.textContent = kpi.target;
    tr.appendChild(tdTarget);

    const tdWeight = document.createElement("td");
    tdWeight.className = "small";
    tdWeight.textContent = kpi.weight;
    tr.appendChild(tdWeight);

    state.supervisors.forEach((_, supIdx) => {
      const td = document.createElement("td");

      const val = (state.actuals[kpi.id][supIdx] ?? 0);

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = val;
      input.title = "Actual";

      const scoreSpan = document.createElement("div");
      scoreSpan.className = "scoreCell";
      scoreSpan.style.marginTop = "6px";

      const s = scoreFor(kpi, val);
      scoreSpan.textContent = round1(s);

      // Coloring
      const ratio = (Number(kpi.target) > 0) ? Math.min((Number(val)||0)/Number(kpi.target), 1) : 0;
      scoreSpan.classList.toggle("scoreOk", ratio >= 0.8);
      scoreSpan.classList.toggle("scoreBad", ratio < 0.5);

      input.addEventListener("input", () => {
        const n = Number(input.value) || 0;
        state.actuals[kpi.id][supIdx] = n;

        const newScore = scoreFor(kpi, n);
        scoreSpan.textContent = round1(newScore);

        const newRatio = (Number(kpi.target) > 0) ? Math.min(n/Number(kpi.target), 1) : 0;
        scoreSpan.classList.toggle("scoreOk", newRatio >= 0.8);
        scoreSpan.classList.toggle("scoreBad", newRatio < 0.5);

        saveState();
        renderTotalsAndChart(); // lightweight update
      });

      td.appendChild(input);
      td.appendChild(scoreSpan);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // Totals row
  const trTot = document.createElement("tr");
  trTot.className = "totalRow";

  const tdTotName = document.createElement("td");
  tdTotName.className = "stickyRight";
  tdTotName.textContent = "الإجمالي";
  trTot.appendChild(tdTotName);

  const tdEmpty1 = document.createElement("td");
  tdEmpty1.textContent = "";
  trTot.appendChild(tdEmpty1);

  const tdEmpty2 = document.createElement("td");
  tdEmpty2.textContent = "100";
  trTot.appendChild(tdEmpty2);

  state.supervisors.forEach((_, supIdx) => {
    const td = document.createElement("td");
    const total = totalForSupervisor(supIdx);
    td.innerHTML = `<span class="totalBadge">${total}</span>`;
    trTot.appendChild(td);
  });

  tbody.appendChild(trTot);

  renderTotalsAndChart();
}

function renderTotalsAndChart(){
  // Grand total (avg)
  const totals = state.supervisors.map((_, i) => totalForSupervisor(i));
  const avg = totals.length ? round1(totals.reduce((a,b)=>a+b,0)/totals.length) : 0;
  document.getElementById("grandTotal").textContent = avg;

  // Chart
  const labels = state.supervisors;
  const data = totals;

  if(!chart){
    const ctx = document.getElementById("chart");
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "النتيجة",
          data
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales: {
          y: { beginAtZero:true, max:100 }
        },
        plugins:{
          legend:{display:false},
          tooltip:{
            callbacks:{
              label: (item)=> ` ${item.parsed.y} / 100`
            }
          }
        }
      }
    });
  }else{
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }
}

// ---------- UI Actions ----------
document.getElementById("addSupervisorBtn").addEventListener("click", () => {
  const name = prompt("اكتب اسم المشرف الجديد:");
  if(!name) return;
  state.supervisors.push(name.trim());
  // expand actuals arrays
  for(const k of state.kpis){
    if(!state.actuals[k.id]) state.actuals[k.id] = [];
    state.actuals[k.id].push(0);
  }
  saveState();
  render();
});

document.getElementById("resetBtn").addEventListener("click", () => {
  const ok = confirm("هل تريد مسح جميع القيم؟");
  if(!ok) return;
  state = { kpis: defaultKpis, supervisors: defaultSupervisors, actuals:{} };
  saveState();
  render();
});

document.getElementById("exportBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "smou-kpi-dubai.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const imported = JSON.parse(txt);
    if(!imported.kpis || !imported.supervisors) throw new Error("ملف غير صالح");
    state = imported;
    saveState();
    render();
  }catch(err){
    alert("فشل الاستيراد: " + err.message);
  }finally{
    e.target.value = "";
  }
});

// ---------- Utils ----------
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

// Initial render
render();
</script>
</body>
</html>
